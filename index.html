<!DOCTYPE html>
<html>
<body>
   
   
   <style>
         video 
         {  
            max-width: 100%;  
            height: 40%;  
         }
   </style>
   
   
   <video id = "myVideo" autoplay muted></video>
   <canvas id = "canvas"></canvas>
   
   <!-- taking jquery library hosted from microsoft content delivery network (could also host it in the same folder) -->
   <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.1.min.js"></script>
   
   <script language="javascript" type="text/javascript">

            var bStop = true;
            
            //called when navigato.getUserMedia() fails to access the webcamera
            function onVideoFail(e) 
            {
                  console.log('webcam fail!', e);
            };

            //return true if getusermedia is supported by browser. Otherwise return false
            function hasGetUserMedia() 
            {
                  return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
                            navigator.mozGetUserMedia || navigator.msGetUserMedia);
            }

            function setupVideo(stream) 
            {
                  video = document.querySelector('video');
                  video.src = window.URL.createObjectURL(stream);
                  webcamstream = stream;
            }
            
            function onUploadSuccess() 
            {
               alert ('video uploaded');
            }
      
            function postVideoToServer(frame) 
            {
                  var data = {};
                  data.video = frame;
                  data.metadata = 'test metadata';
                  data.action = "upload_video";
                  jQuery.post("https://mathewstylianidis.github.io/VideoStream/Server.html", data, onUploadSuccess);
            }
      
            function draw(v, cc, w, h, c) 
            {
                  cc.drawImage(v, 0, 0, w, h);  //just for testing
                  var frameData =c.toDataURL(); //turn canvas to raw png format
                  postVideoToServer(frameData);
                 
                 if(!bStop) 
                    setTimeout( function() { draw(v, cc, w, h, c) }, 40);   //40 * 25 = 1000 ==> draw canvas every 40 ms to have 25FPS
            }
            
            function startRecording()
            {       
                  var canvas = document.getElementById('canvas');
                  var canvasContext = canvas.getContext('2d');
                  var width = video.videoWidth;
                  var height = video.videoHeight;

                  canvas.width = width;
                  canvas.height = height; 
               
                  bStop = false;
                  draw(video, canvasContext, width, height, canvas)            
            }
            
            
            function stopRecording()
            {
               bStop = true; 
            }
         
            // We set an empty object because old browsers might not implement media devices
            if (navigator.mediaDevices === undefined) 
                  navigator.mediaDevices = {};

            //check if getusermedia is supported
            if (!hasGetUserMedia()) 
                  alert("getUserMedia is not implemented in this browser")


         //get objects to handle urls and user media
         window.URL = window.URL || window.webkitURL;
         navigator.getUserMedia = navigator.getUserMedia || 
                                  navigator.webkitGetUserMedia ||
                                  navigator.mozGetUserMedia || 
                                  navigator.msGetUserMedia;


         var video;
         var streamRecorder;
         var webcamstream;

         if (navigator.getUserMedia) 
            navigator.getUserMedia({audio: true, video: true}, setupVideo, onVideoFail);
         else
            alert ('failed');



         /*function stopRecording() {
           streamRecorder.getRecordedData(postVideoToServer);
          }

         
          
         */
    </script>

    <div id="webcamcontrols">
        <button onclick="startRecording()" class="recordbutton">Turn camera on</button>
       <button onclick="stopRecording()" class="recordbutton">Turn camera off</button>
    </div>



</body>
</html>
